{"version":3,"file":"Coi-CVpIsTxX.js","sources":["../../../resources/js/survey.js","../../../resources/js/views/Coi.vue"],"sourcesContent":["class Question {\n    constructor(question) {\n        this.question_text = question.question;\n        this.name = question.name;\n        this.options = question.options;\n        this.validationRules = question.validation;\n        this.type = question.type;\n        this.show = question.show;\n        this.class = question.class;\n        this.content = question.content;\n    }\n}\n\nclass YesNoQuestion extends Question {\n    constructor(question) {\n        super(question)\n        this.type = 'multiple-choice';\n        this.options = [{\n                label: 'Yes',\n                value: 1\n            },\n            {\n                label: 'No',\n                value: 0\n            }\n        ];\n    }\n}\n\nfunction makeQuestion(questionDef) {\n    if (questionDef.type === 'yes-no') {\n        return new YesNoQuestion(questionDef);\n    }\n\n    return new Question(questionDef);\n}\n\nclass Survey {\n    constructor(surveyDefinition) {\n        this._name = surveyDefinition.name;\n        this._questions = surveyDefinition.questions.map(q => makeQuestion(q));\n\n    }\n\n    get name() {\n        return this._name;\n    }\n\n    get questions() {\n        return this._questions\n    }\n\n    getResponseTemplate() {\n        const rsp = {};\n        this.questions\n            .filter(q => q.type === 'content')\n            .forEach(q => {\n                rsp[q.name] = null\n            });\n        return rsp;\n\n    }\n}\n\nexport default Survey\n","<script>\nimport coiDef from '../../surveys/coi_v2.json'\nimport Survey from '@/survey'\nimport api from '@/http/api'\nimport is_validation_error from '@/http/is_validation_error';\nimport CoiPolicy from '@/components/coi/CoiPolicy.vue'\nimport MarkdownBlock from '@/components/MarkdownBlock.vue'\n\nconst survey = new Survey(coiDef);\n\nexport default {\n    name: 'Coi',\n    components: {\n        CoiPolicy,\n        MarkdownBlock\n    },\n    props: {\n        code: {\n            required: true,\n            type: String\n        }\n    },\n    data() {\n        return {\n            coiDef,\n            survey,\n            response: survey.getResponseTemplate(),\n            errors: {},\n            groupName: null,\n            verifying: false,\n            saved: false,\n            saving: false,\n            redirectCountdown: 5\n        }\n    },\n    computed: {\n        codeIsValid() {\n            return this.groupName !== null;\n        },\n        coiTitle() {\n            return `${survey.name} for ${this.groupName}`;\n        },\n        membership () {\n            return this.$store.getters\n                    .currentUser\n                    .person.memberships.find(m => {\n                        return m.group\n                            && m.group.coi_code === this.code\n                    });\n        },\n        groupMemberId() {\n            if (this.membership) {\n                return this.membership.id;\n            }\n\n            return null;\n        },\n    },\n    watch: {\n        code: {\n            immediate: true,\n            handler () {\n                this.initResponseValues()\n            }\n        }\n    },\n    async mounted() {\n        this.verifyCode();\n        await this.$store.dispatch('getCurrentUser')\n    },\n    methods: {\n        initResponseValues() {\n            if (this.membership && this.membership.cois.length > 0) {\n                const lastResponse = {...this.membership.cois[this.membership.cois.length -1]};\n\n                const v2ResponseData = (lastResponse.version === '1.0.0')\n                    ? this.transformV1Response(lastResponse.data)\n                    : {...lastResponse.data};\n\n                v2ResponseData.coi_attestation = null\n                v2ResponseData.data_policy_attestation = null\n                this.response = v2ResponseData;\n            }\n\n            return {}\n        },\n\n        transformV1Response (lastResponse) {\n            const v2Response = {\n                work_fee_lab: lastResponse.work_fee_lab,\n                contributions_to_gd_in_group: lastResponse.contributions_to_gd_in_ep,\n                contributions_to_genes: lastResponse.contributions_to_genes,\n                coi: (lastResponse.independent_efforts === 0 && lastResponse.coi === 0) ? 0 : 1,\n                coi_details: [\n                                lastResponse.independent_efforts_details,\n                                lastResponse.coi_details\n                            ].join(\";\\n\")\n            }\n\n            if ((lastResponse.independent_efforts === 2 || lastResponse.coi === 2)) {\n                v2Response.coi = 2;\n            }\n\n            return v2Response;\n        },\n\n        showQuestion(question) {\n            if (!question.show) {\n                return true;\n            }\n            if (Array.isArray(question.show.value)) {\n                return question.show.value.includes(this.response[question.show.name]);\n            }\n            return (this.response[question.show.name] === question.show.value);\n        },\n        verifyCode() {\n            this.verifying = true;\n            api.get(`/api/coi/${this.code}/group`)\n                .then(response => {\n                    this.groupName = response.data.display_name\n                })\n                .then(() => {\n                    this.verifying = false;\n                })\n        },\n        async storeResponse() {\n            this.saving = true;\n            try {\n                await this.$store.dispatch(\n                    'storeCoi',\n                    {\n                        code: this.code,\n                        groupMemberId: this.groupMemberId,\n                        coiData: this.response,\n                    }\n                );\n                this.saved = true;\n                await this.$store.dispatch('forceGetCurrentUser');\n                this.$router.push({name: 'Dashboard'});\n            } catch (error) {\n                if (is_validation_error(error)) {\n                    this.errors = error.response.data.errors\n                } else {\n                    this.$store.commit('pushError', `You can not complete a COI for ${this.groupName} because you are not a member.`)\n                }\n            }\n            this.saving = false;\n        },\n    }\n}\n</script>\n<template>\n  <div>\n    <card v-if=\"!codeIsValid\" :title=\"verifying ? `Loading COI Form` : `COI Form not found`\">\n      <div v-if=\"!verifying\">\n        We couldn't find this COI.\n      </div>\n    </card>\n    <card v-if=\"!groupMemberId\" title=\"There's a problem\">\n      We can't seem to find your membership for this group id.  Please try refreshing.\n    </card>\n\n    <card v-else-if=\"codeIsValid\" :title=\"coiTitle\" class=\"mx-auto relative\" style=\"max-width:800px\">\n      <CoiPolicy />\n      <hr>\n      <h2>COI</h2>\n      <div class=\"relative\">\n        <div\n          v-for=\"question in survey.questions\"\n          :key=\"question.name\"\n          :class=\"question.class\"\n        >\n          <transition name=\"slide-fade-down\">\n            <div v-if=\"question.type == 'content'\">\n              <MarkdownBlock\n                :markdown=\"question.content\"\n              />\n            </div>\n            <input-row\n              v-else\n              v-show=\"showQuestion(question)\"\n              :label=\"question.question_text\"\n              :errors=\"errors[question.name]\"\n              :vertical=\"true\"\n            >\n              <textarea\n                v-if=\"question.type == 'text'\"\n                v-model=\"response[question.name]\"\n                class=\"w-full h-24\"\n                :name=\"question.name\"\n              />\n\n              <div v-if=\"question.type == 'multiple-choice'\">\n                <label v-for=\"option in question.options\" :key=\"option.value\" class=\"mb-1\">\n                  <input\n                    v-model=\"response[question.name]\"\n                    type=\"radio\"\n                    :value=\"option.value\"\n                    :name=\"question.name\"\n                  >\n                  <div>{{ option.label }}</div>\n                </label>\n              </div>\n\n              <input\n                v-if=\"question.type == 'string'\"\n                v-model=\"response[question.name]\"\n                type=\"text\"\n                :name=\"question.name\"\n              >\n            </input-row>\n          </transition>\n        </div>\n        <button-row :show-cancel=\"false\" @submit-clicked=\"storeResponse()\">\n          <slot v-if=\"saving\">\n            Saving...\n          </slot>\n        </button-row>\n      </div>\n    </card>\n\n    <note class=\"container\">\n      GroupMemberId: {{ groupMemberId }}\n    </note>\n  </div>\n</template>\n"],"names":["Question","question","YesNoQuestion","makeQuestion","questionDef","Survey","surveyDefinition","q","rsp","survey","coiDef","_sfc_main","CoiPolicy","MarkdownBlock","m","lastResponse","v2ResponseData","v2Response","api","response","error","is_validation_error","_hoisted_2","_hoisted_4","_hoisted_6","_hoisted_7","_createElementBlock","$options","_createCommentVNode","_createBlock","_component_card","$data","_withCtx","_hoisted_1","_createVNode","_component_CoiPolicy","_createElementVNode","_cache","_openBlock","_Fragment","_renderList","_normalizeClass","_Transition","_hoisted_3","_component_MarkdownBlock","_component_input_row","$event","_hoisted_5","option","_toDisplayString","_vShow","_component_button_row","_renderSlot","_ctx","_createTextVNode","_component_note"],"mappings":"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"}