import{_ as P,G as U,a as l,c as f,b as p,f as s,a2 as B,d as t,i as d,w as n,h as v,e as L,j as b,F as G,m as N,a9 as O,a1 as k,B as q,ap as H,C as R,ae as x,D as Y,aa as z}from"./app-CozNNJHL.js";import{s as J,f as K,l as Q}from"./log_entry_repository-BQuOI55z.js";import{C as W,P as X}from"./CoiList-CqhsYmoi.js";import{A as Z}from"./ActivityLog-DovT43si.js";import{C as ee}from"./CustomEmailForm-Cdm8Gm4E.js";import{P as oe}from"./CoiDetail-C67L38bj.js";import te from"./DemographicsForm-Bgcc8dPc.js";import"./ProfileForm-Du9iPd3D.js";import"./ExpertisesView-DPvy3TK5.js";const se={name:"MembershipList",props:{person:{type:Object,required:!0}},data(){return{sort:{field:"group.displayName",desc:!1},fields:[{name:"group.displayName",type:String,sortable:!0,label:"Name"},{name:"group.type.name",type:String,sortable:!0,label:"Type"},{name:"roles",type:String,sortable:!1,label:"Roles",resolveValue(o){return o.roles.map(e=>e.name).join(", ")}},{name:"permissions",type:String,sortable:!1,label:"Permissions",resolveValue(o){return o.permissions.map(e=>e.name).join(", ")}},{name:"start_date",type:Date,sortable:!0,label:"Started"},{name:"end_date",type:Date,sortable:!0,label:"Ended"}]}},computed:{memberships(){return this.person.memberships?this.person.memberships.map(o=>(o.group&&(o.group=new U(o.group)),o)):[]}},methods:{goToGroup(o){this.$router.push({name:"GroupDetail",params:{uuid:o.group.uuid}})}}};function re(o,e,m,C,r,i){const c=l("data-table");return p(),f("div",null,[s(c,{sort:r.sort,"onUpdate:sort":e[0]||(e[0]=h=>r.sort=h),fields:r.fields,data:i.memberships,"row-click-handler":i.goToGroup,"row-class":()=>"cursor-pointer"},null,8,["sort","fields","data","row-click-handler"])])}const le=P(se,[["render",re]]),ne={name:"PersonMergeForm",props:{authority:{type:Object,required:!1},obsolete:{type:Object,default:()=>({})}},emits:["saved","canceled"],data(){return{authorityCopy:null,obsoleteCopy:null,errors:{}}},watch:{authority:{immediate:!0,handler(o){o&&(this.authorityCopy={...o.attributes})}},obsolete:{immediate:!0,handler(o){o&&(this.obsoleteCopy={...o.attributes})}}},methods:{async commitMerge(){try{this.errors={},await this.$store.dispatch("people/mergePeople",{authority:this.authorityCopy,obsolete:this.obsoleteCopy}),this.authorityId=null,this.obsoleteIds=null,this.$emit("saved")}catch(o){B(o)&&(this.errors=o.response.data.errors)}},cancelMerge(){this.authorityId=null,this.obsoleteId=null,this.$emit("canceled")}}};function ie(o,e,m,C,r,i){const c=l("note"),h=l("person-search-select"),a=l("input-row"),g=l("button-row");return p(),f("div",null,[e[6]||(e[6]=t("p",{class:"mb-8"},[d(" Merging peple will do the following: "),t("ol",{class:"list-decimal ml-6"},[t("li",null,"Add the authoritative person to all groups of which the obsolete person is a member."),t("li",null,"Delete the obsolete person, their memberships, their invite, and their user account (if activated).")])],-1)),s(a,{label:"Merge",vertical:""},{label:n(()=>[e[3]||(e[3]=d(" Merge ")),s(c,{class:"inline-block"},{default:n(()=>e[2]||(e[2]=[d(" (Obsolete person that will be deleted) ")])),_:1})]),default:n(()=>[s(h,{modelValue:r.obsoleteCopy,"onUpdate:modelValue":e[0]||(e[0]=w=>r.obsoleteCopy=w),"allow-add":!1},null,8,["modelValue"])]),_:1}),s(a,{label:"Into",errors:r.errors.authority_id,vertical:""},{label:n(()=>[e[5]||(e[5]=d(" Into ")),s(c,{class:"inline"},{default:n(()=>e[4]||(e[4]=[d(" (Authoritative person) ")])),_:1})]),default:n(()=>[s(h,{modelValue:r.authorityCopy,"onUpdate:modelValue":e[1]||(e[1]=w=>r.authorityCopy=w),"allow-add":!1},null,8,["modelValue"])]),_:1},8,["errors"]),s(g,{"submit-text":"Merge",onSubmitted:i.commitMerge,onCanceled:i.cancelMerge},null,8,["onSubmitted","onCanceled"])])}const ae=P(ne,[["render",ie]]),ue={name:"PersonMailLog",components:{CustomEmailForm:ee},props:{person:{type:Object,required:!0},mail:{type:Array,required:!0}},data(){return{currentEmail:{},showResendDialog:null}},computed:{},methods:{initResend(o){this.currentEmail={...o},this.showResendDialog=!0},cleanupResend(){this.currentEmail={},this.showResendDialog=!1,this.$store.dispatch("people/getMail",this.person)}}},de={key:0,class:"well"},pe={key:0},me={key:1},be={class:"mt-1"},ge=["innerHTML"],fe=["onClick"];function he(o,e,m,C,r,i){const c=l("CustomEmailForm"),h=l("modal-dialog");return p(),f("div",null,[m.mail.length==0?(p(),f("div",de,b(m.person.first_name)+" has not received any mail via the GPM. ",1)):v("",!0),(p(!0),f(G,null,N(m.mail,a=>(p(),f("div",{key:a.id,class:"w-3/4 my-4 p-4 border"},[e[5]||(e[5]=t("span",{class:"text-gray-600"},"Sent at",-1)),d(" "+b(o.formatDate(a.created_at))+" ",1),t("div",null,[e[1]||(e[1]=t("span",{class:"text-gray-600"},"To:",-1)),d(" "+b(a.to.map(g=>g.address).join(", ")),1)]),a.cc?(p(),f("div",pe,[e[2]||(e[2]=t("span",{class:"text-gray-600"},"CC:",-1)),d(" "+b(a.cc.map(g=>g.address).join(", ")),1)])):v("",!0),a.bcc?(p(),f("div",me,[e[3]||(e[3]=t("span",{class:"text-gray-600"},"BCC:",-1)),d(" "+b(a.bcc.map(g=>g.address).join(", ")),1)])):v("",!0),t("div",be,[e[4]||(e[4]=t("span",{class:"text-gray-600"},"Subject:",-1)),d(" "+b(a.subject),1)]),e[6]||(e[6]=t("hr",null,null,-1)),t("div",{innerHTML:a.body},null,8,ge),e[7]||(e[7]=t("hr",null,null,-1)),o.hasPermission("people-manage")||o.coordinatesPerson(m.person)?(p(),f("button",{key:2,class:"btn btn-xs",onClick:O(g=>i.initResend(a),["stop"])}," Resend ",8,fe)):v("",!0)]))),128)),(p(),L(k,{to:"body"},[s(h,{modelValue:r.showResendDialog,"onUpdate:modelValue":e[0]||(e[0]=a=>r.showResendDialog=a),title:"Resend Email"},{default:n(()=>[s(c,{"mail-data":r.currentEmail,onSent:i.cleanupResend,onCanceled:i.cleanupResend},null,8,["mail-data","onSent","onCanceled"])]),_:1},8,["modelValue"])]))])}const ce=P(ue,[["render",he]]),ye={name:"PersonDetail",components:{TabsContainer:H,MembershipList:le,PersonProfile:X,DemographicsForm:te,PersonMergeForm:ae,CoiList:W,ActivityLog:Z,PersonMailLog:ce,ProfilePicture:oe},props:{uuid:{required:!0,type:String}},data(){return{showDeleteConfirmation:!1,showMergeForm:!1,mailLoading:!1,logsLoading:!1,showRetireAllConfirmation:!1,retireAlsoDisableLogin:!1,retireReason:"",retireAllBusy:!1}},watch:{uuid:{immediate:!0,async handler(){await this.$store.dispatch("people/getPerson",{uuid:this.uuid}),this.coordinatesPerson(this.person)&&(this.getLogEntries(),this.getMailLog())}},"person.memberships":function(o){o.length>0&&(this.getLogEntries(),this.getMailLog())}},computed:{...q({person:"people/currentItem"}),showModal:{get(){return this.$route.meta.showModal},set(o){o&&this.$router.push({name:"PersonEdit",params:{uuid:this.person.uuid}}),this.$router.push({name:"PersonDetail",params:{uuid:this.person.uuid}})}},sortedMailLog(){return[...this.person.mailLog].sort((o,e)=>o.created_at===e.created_at?0:Date.parse(o.created_at)>Date.parse(e.created_at)?-1:1)}},methods:{async commitDelete(){await this.$store.dispatch("people/deletePerson",this.person),this.showDeleteConfirmation=!1,this.$router.go(-1)},handleMerged(){this.showMergeForm=!1,this.$router.go(-1)},async getMailLog(){this.mailLoading=!0,await this.$store.dispatch("people/getMail",this.person),this.mailLoading=!1},async getLogEntries(){this.logsLoading=!0,await this.fetchEntries(`/api/people/${this.uuid}/activity-logs`),this.logsLoading=!1},async commitRetireAll(){try{this.retireAllBusy=!0;const o=await this.saveEntry(`/api/people/${this.person.uuid}/retire`,{disable_login:this.retireAlsoDisableLogin,reason:this.retireReason||null});this.showRetireAllConfirmation=!1;const e=Number((o==null?void 0:o.memberships_retired)??0),m=[`Retired from ${e} ${e===1?"group":"groups"}.`];o!=null&&o.disable_login&&m.push("Login has been disabled for this member."),await this.$store.dispatch("people/getPerson",{uuid:this.uuid}),this.getLogEntries(),this.$store.commit("pushSuccess",m.join(" "))}catch{this.$store.commit("pushError","Failed to retire user — see console/logs.")}finally{this.retireAllBusy=!1}}},setup(){return{formatDate:z,logEntries:Q,fetchEntries:K,saveEntry:J}},mounted(){this.$store.dispatch("people/clearCurrentItem")}},we={class:"pb-4"},ve={class:"flex space-x-4"},Ce={class:"flex-1"},Me={class:"flex justify-between items-center"},Pe={class:"flex space-x-4 items-center"},Le={class:"flex space-x-4 items-center"},De={class:"border my-4 p-4 bg-red-100 border-red-200 rounded"},_e={class:"mt-3"},Re={class:"flex items-start space-x-2"},ke={class:"mt-3"};function Ve(o,e,m,C,r,i){const c=l("ProfilePicture"),h=l("router-link"),a=l("note"),g=l("icon-edit"),w=l("dictionary-row"),V=l("MembershipList"),y=l("tab-item"),E=l("PersonProfile"),A=l("DemographicsForm"),S=l("CoiList"),D=l("refresh-button"),F=l("PersonMailLog"),T=l("ActivityLog"),I=l("TabsContainer"),j=l("router-view"),M=l("modal-dialog"),_=l("button-row"),$=l("PersonMergeForm");return p(),f("div",null,[t("header",we,[t("div",ve,[s(c,{person:o.person,style:{width:"155px"},class:"rounded-lg"},null,8,["person"]),t("div",Ce,[s(h,{class:"note",to:"/people"},{default:n(()=>e[12]||(e[12]=[d(" People ")])),_:1}),t("h1",Me,[t("div",null,[d(b(o.person.name)+" ",1),s(a,null,{default:n(()=>[d("ID: "+b(o.person.id),1)]),_:1})]),o.hasPermission("people-manage")||o.userIsPerson(o.person)||o.coordinatesPerson(o.person)?(p(),L(h,{key:0,to:`/people/${m.uuid}/edit`,class:"btn btn-xs flex-grow-0"},{default:n(()=>[s(g,{width:"16",heigh:"16"})]),_:1},8,["to"])):v("",!0)]),s(w,{label:"Email","label-class":"w-24 font-bold"},{default:n(()=>[d(b(o.person.email),1)]),_:1}),s(w,{label:"Institution","label-class":"w-24 font-bold"},{default:n(()=>[d(b(o.person.institution?o.person.institution.name:null),1)]),_:1})])])]),s(I,null,{default:n(()=>[s(y,{label:"groups"},{default:n(()=>[e[13]||(e[13]=t("h2",null,"Groups",-1)),s(V,{person:o.person},null,8,["person"])]),_:1}),s(y,{label:"Info"},{default:n(()=>[e[14]||(e[14]=t("h2",null,"Profile",-1)),s(E,{person:o.person},null,8,["person"])]),_:1}),s(y,{label:"Demographics",visible:o.hasRole("super-admin")||o.userIsPerson(o.person)},{default:n(()=>[s(A,{person:o.person},null,8,["person"])]),_:1},8,["visible"]),s(y,{label:"Conflict of Interest"},{default:n(()=>[s(S,{person:o.person},null,8,["person"])]),_:1}),s(y,{label:"Email Log",visible:o.hasPermission("people-manage")||o.userIsPerson(o.person)||o.coordinatesPerson(o.person)},{default:n(()=>[t("header",Pe,[t("h2",null,"Mail sent to "+b(o.person.first_name),1),s(D,{loading:r.mailLoading,onClick:i.getMailLog},null,8,["loading","onClick"])]),s(F,{person:o.person,mail:i.sortedMailLog},null,8,["person","mail"])]),_:1},8,["visible"]),s(y,{label:"Log",visible:o.hasPermission("people-manage")||o.coordinatesPerson(o.person)},{default:n(()=>[t("div",Le,[e[15]||(e[15]=t("h2",null,"Log Entries",-1)),s(D,{loading:r.logsLoading,onClick:i.getLogEntries},null,8,["loading","onClick"])]),s(T,{"log-entries":C.logEntries,"api-url":`/api/people/${o.person.uuid}/activity-logs`,"log-updated":i.getLogEntries},null,8,["log-entries","api-url","log-updated"])]),_:1},8,["visible"]),s(y,{label:"Admin",visible:o.hasPermission("people-manage")},{default:n(()=>[t("section",De,[e[18]||(e[18]=t("h2",{class:"mb-4 text-red-800"}," Here be dragons. Proceed with caution. ",-1)),t("p",null,[t("button",{class:"btn btn red",onClick:e[0]||(e[0]=u=>r.showMergeForm=!0)}," Merge Person into another ")]),t("p",null,[t("button",{class:"btn btn red",onClick:e[1]||(e[1]=u=>r.showDeleteConfirmation=!0)}," Delete Person ")]),e[19]||(e[19]=t("p",null," ",-1)),t("p",null,[e[16]||(e[16]=d(" This button will remove the person from all the groups they are a member of.")),e[17]||(e[17]=t("br",null,null,-1)),t("button",{class:"btn btn red",onClick:e[2]||(e[2]=u=>r.showRetireAllConfirmation=!0)}," Retire Person ")])])]),_:1},8,["visible"])]),_:1}),(p(),L(k,{to:"body"},[s(M,{modelValue:i.showModal,"onUpdate:modelValue":e[3]||(e[3]=u=>i.showModal=u),title:o.$route.meta.title},{default:n(()=>[s(j,{name:"modal"})]),_:1},8,["modelValue","title"]),s(M,{modelValue:r.showDeleteConfirmation,"onUpdate:modelValue":e[5]||(e[5]=u=>r.showDeleteConfirmation=u),title:`You are about to delete ${o.person.name}`},{default:n(()=>[e[20]||(e[20]=t("p",null,"You are about to delete this person. All related data will also be deleted including:",-1)),e[21]||(e[21]=t("ul",{class:"list-disc pl-6"},[t("li",null,"User record, system roles, and system permissions (if account is activated)"),t("li",null,"Invite"),t("li",null,"Group Memberships and group roles (if any)")],-1)),e[22]||(e[22]=t("div",{class:"border my-4 px-2 py-1 font-bold bg-red-100 border-red-200 rounded text-red-800"}," This cannot be undone. ",-1)),s(_,{"submit-text":`Delete ${o.person.name}`,"submit-variant":"red",onSubmitted:i.commitDelete,onCanceled:e[4]||(e[4]=u=>r.showDeleteConfirmation=!1)},null,8,["submit-text","onSubmitted"])]),_:1},8,["modelValue","title"]),s(M,{modelValue:r.showMergeForm,"onUpdate:modelValue":e[7]||(e[7]=u=>r.showMergeForm=u),title:`Merge ${o.person.name} into another person`},{default:n(()=>[s($,{obsolete:o.person,onSaved:i.handleMerged,onCanceled:e[6]||(e[6]=u=>r.showMergeForm=!1)},null,8,["obsolete","onSaved"])]),_:1},8,["modelValue","title"]),s(M,{modelValue:r.showRetireAllConfirmation,"onUpdate:modelValue":e[11]||(e[11]=u=>r.showRetireAllConfirmation=u),title:`Retire ${o.person.name} from all groups and disable account?`},{default:n(()=>[e[25]||(e[25]=t("p",null,"This will:",-1)),e[26]||(e[26]=t("ul",{class:"list-disc pl-6"},[t("li",null,"End all active group memberships"),t("li",null,"Mark the person as retired"),t("li",null,"Optionally disable login/revoke tokens")],-1)),t("div",_e,[t("label",Re,[R(t("input",{type:"checkbox","onUpdate:modelValue":e[8]||(e[8]=u=>r.retireAlsoDisableLogin=u),class:"mt-1"},null,512),[[x,r.retireAlsoDisableLogin]]),e[23]||(e[23]=t("span",null,[d(" Also disable login for this user."),t("br"),t("small",{class:"text-gray-500"}," This will delete the user's account data but keep their member record for reference. Contact an administrator if you need to restore their access later. ")],-1))])]),t("div",ke,[e[24]||(e[24]=t("label",{class:"block font-semibold mb-1"},"Reason (optional)",-1)),R(t("textarea",{"onUpdate:modelValue":e[9]||(e[9]=u=>r.retireReason=u),class:"w-full border rounded p-2",rows:"3",placeholder:"e.g., Left ClinGen"},null,512),[[Y,r.retireReason]])]),e[27]||(e[27]=t("div",{class:"border my-4 px-2 py-1 font-bold bg-red-100 border-red-200 rounded text-red-800"}," This cannot be undone. ",-1)),s(_,{"submit-text":`Retire ${o.person.name}`,"submit-variant":"red",busy:r.retireAllBusy,onSubmitted:i.commitRetireAll,onCanceled:e[10]||(e[10]=u=>r.showRetireAllConfirmation=!1)},null,8,["submit-text","busy","onSubmitted"])]),_:1},8,["modelValue","title"])]))])}const Be=P(ye,[["render",Ve]]);export{Be as default};
//# sourceMappingURL=PersonDetail-j2Jdz3BE.js.map
