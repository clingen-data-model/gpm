import{_ as C,c as a,b as n,d as l,F as v,m as y,n as j,$ as B,i as g,j as _,a as c,e as h,f as o,h as b,w as d,C as x,D as P,a0 as k,a1 as z,a2 as O,a3 as V,p as W,P as Y,a4 as H,v as J,q as S,A as K}from"./app-xUpSbDwL.js";import{_ as Q,a as X}from"./ExpertisesView-f_XRcQNL.js";import{_ as Z}from"./ProfileForm-CLONd2zZ.js";const $={name:"MemberSuggestions",props:{suggestions:{required:!0,type:Array}},emits:["selected"],methods:{useSuggestion(r){this.$emit("selected",r)}}},ee={key:0},se=["onClick"];function re(r,e,p,m,s,i){return n(),a("div",null,[l("ul",null,[(n(!0),a(v,null,y(p.suggestions,w=>(n(),a("li",{key:w.uuid,class:j(["flex justify-between my-2",{"text-gray-500":w.alreadyMember}])},[B(r.$slots,"default",{},()=>[g(_(w.name)+" ",1),w.alreadyMember?(n(),a("div",ee," Already a member ")):(n(),a("button",{key:1,class:"btn btn-xs",onClick:u=>i.useSuggestion(w)}," Add as member ",8,se))])],2))),128))])])}const te=C($,[["render",re]]),I=K.groups,ne={name:"AddMemberForm",components:{MemberSuggestions:te,CredentialsView:X,ExpertisesView:Q,ProfileForm:Z},props:{uuid:{required:!0,type:String},memberId:{required:!1,default:null}},emits:["saved","canceled","closed"],setup(){const r=J(),e=S(()=>r.getters["groups/currentItemOrNew"]||{}),p=S(()=>r.getters["people/all"]||{}),m=I.roles,s=I.permissions;return{group:e,people:p,roles:m,permissions:s}},data(){return{newMember:new V,errors:{},suggestedPeople:[],legendValues:[1,2],showProfileForm:!1,addAnother:!1}},computed:{originalMember(){return this.group.findMember(this.memberId)},nameErrors(){return[this.errors.first_name,this.errors.last_name].flat().filter(r=>r)},needsCredentials(){return!this.newMember.person.credentials||this.newMember.person.credentials.length===0},needsExpertise(){return!this.newMember.person.expertises||this.newMember.person.expertises.length===0},roleRequiresNotification(){return this.newMember.hasRole("coordinator")||this.newMember.hasRole("grant-liaison")}},watch:{group(){this.syncMember()}},mounted(){this.initNewMember(),this.syncMember()},created(){this.debounceSuggestions=H(this.getSuggestedPeople,500)},methods:{async getSuggestedPeople(){if(!this.newMember.first_name&&!this.newMember.last_name&&!this.newMember.email){this.suggestedPeople=[];return}const r={page:1,"sort[field]":"name","sort[dir]":"ASC","where[first_name]":this.newMember.first_name,"where[last_name]":this.newMember.last_name,"where[email]":this.newMember.email,with:["memberships"]};this.suggestedPeople=await W.get("/api/people",{params:r}).then(e=>e.data.data.map(p=>(p.alreadyMember=this.isAlreadyMember(p),new Y(p))))},initNewMember(){this.newMember=new V},syncMember(){try{this.memberId&&(this.newMember=this.originalMember.clone())}catch(r){this.group.isPersisted()&&alert(r)}},clearForm(){this.initNewMember()},cancel(){this.clearForm(),this.$emit("canceled")},async saveAndExit(){this.roleRequiresNotification&&(this.newMember.is_contact=!0),await this.save(),this.clearForm(),this.suggestedPeople=[],this.addAnother||this.$emit("saved"),this.newMember.id&&this.$router.replace({name:"AddMember"})},async saveAndEditProfile(){const r=await this.save();this.newMember=new V(r),this.showProfileForm=!0},async save(){try{if(!this.newMember.isPersisted()){if(!this.newMember.person.isPersisted()){const r=await this.inviteNewMember(this.group,this.newMember);return this.$store.commit("pushSuccess",`${r.person.name} invited to join ${r.group.name}`),r}if(this.newMember.person.isPersisted()){const r=await this.addPersonAsMember(this.group,this.newMember);return this.$store.commit("pushSuccess",`${r.person.name} added to ${r.group.name}`),r}}if(this.newMember.isPersisted()){const r=await this.updateExistingMember(this.group,this.newMember);return this.$store.commit("pushSuccess",`${r.person.name}'s membership was updated.`),r}}catch(r){if(O(r)){this.errors=r.response.data.errors;return}throw r}},async inviteNewMember(r,e){const p=await this.$store.dispatch("groups/memberInvite",{uuid:r.uuid,data:{firstName:e.person.first_name,lastName:e.person.last_name,email:e.person.email,roleIds:e.roles.map(m=>m.id),isContact:e.is_contact,expertise:e.expertise,notes:e.notes,training_level_1:e.training_level_1,training_level_2:e.training_level_2}});return e.permissions.length>0&&await this.$store.dispatch("groups/memberGrantPermission",{uuid:r.uuid,memberId:p.data.id,permissionIds:e.permissions.map(m=>m.id)}),p.data},async addPersonAsMember(r,e){const p={uuid:r.uuid,personId:e.person_id,roleIds:e.roles.map(s=>s.id),data:{is_contact:e.is_contact,expertise:e.expertise,notes:e.notes,training_level_1:e.training_level_1,training_level_2:e.training_level_2}},m=await this.$store.dispatch("groups/memberAdd",p);return e.permissions.length>0&&await this.$store.dispatch("groups/memberGrantPermission",{uuid:r.uuid,memberId:m.id,permissionIds:e.permissions.map(s=>s.id)}),m},async updateExistingMember(r,e){const p=await this.$store.dispatch("groups/memberUpdate",{groupUuid:r.uuid,memberId:e.id,data:{is_contact:this.newMember.is_contact,expertise:this.newMember.expertise,notes:this.newMember.notes,training_level_1:this.newMember.training_level_1,training_level_2:this.newMember.training_level_2}}).then(m=>m.data);return await this.$store.dispatch("groups/memberSyncRoles",{group:r,member:e}),await this.syncPermissions(r,e),p},async syncPermissions(r,e){const m=r.findMember(this.newMember.id).permissions.map(u=>u.id),s=e.permissions.map(u=>u.id),i=s.filter(u=>!m.includes(u)),w=m.filter(u=>!s.includes(u));i.length>0&&this.$store.dispatch("groups/memberGrantPermission",{uuid:r.uuid,memberId:e.id,permissionIds:i}),w.forEach(u=>{this.$store.dispatch("groups/memberRevokePermission",{uuid:r.uuid,memberId:e.id,permissionId:u})})},useExistingPerson(r){this.newMember.person_id=r.id,this.newMember.person=r.clone()},isAlreadyMember(r){return this.group.members.map(e=>e.person.id).includes(r.id)},handleRoleChange(){},handleProfileUpdate(r){this.newMember.person=r,this.showProfileForm=!1,this.$store.dispatch("groups/getMembers",this.group)}}},ie={class:"flex"},oe={class:"flex-1"},le={key:0},ae={class:"flex space-x-2"},de=["errors"],me={key:1},ue={class:"border-t mt-4 pt-2"},pe={class:"flex flex-col h-24 flex-wrap"},be={key:0,class:"border-t mt-2 pt-2 pl-2"},ce={class:"flex justify-between w-full items-center"},ge={class:"flex flex-col h-24 flex-wrap"},we={class:"px-2 py-1 bg-gray-100 border relative text-xs"},he={class:"flex space-x-2"},_e={key:0,class:"pt-2 border-l pl-2 ml-2 flex-1"},fe={key:0,class:"mb-2 p-2 alert alert-warning"},Me={key:0},ve={key:1},ye={key:2},xe={key:3},Pe={key:4};function Ve(r,e,p,m,s,i){const w=c("input-row"),u=c("dictionary-row"),E=c("CredentialsView"),A=c("ExpertisesView"),N=c("static-alert"),F=c("popover"),R=c("note"),f=c("checkbox"),U=c("badge"),q=c("collapsible"),G=c("MemberSuggestions"),T=c("button-row"),D=c("ProfileForm"),L=c("modal-dialog");return n(),a(v,null,[l("div",null,[l("div",ie,[l("div",oe,[!s.newMember.id&&!s.newMember.person_id?(n(),a("div",le,[o(w,{label:"Name",errors:i.nameErrors},{default:d(()=>[l("div",ae,[x(l("input",{"onUpdate:modelValue":e[0]||(e[0]=t=>s.newMember.person.first_name=t),type:"text",placeholder:"First",class:"block w-1/2",onInput:e[1]||(e[1]=(...t)=>r.debounceSuggestions&&r.debounceSuggestions(...t))},null,544),[[P,s.newMember.person.first_name]]),x(l("input",{"onUpdate:modelValue":e[2]||(e[2]=t=>s.newMember.person.last_name=t),type:"text",placeholder:"Last",class:"block w-1/2",errors:s.errors.last_name,onInput:e[3]||(e[3]=(...t)=>r.debounceSuggestions&&r.debounceSuggestions(...t))},null,40,de),[[P,s.newMember.person.last_name]])])]),_:1},8,["errors"]),o(w,{modelValue:s.newMember.person.email,"onUpdate:modelValue":e[4]||(e[4]=t=>s.newMember.person.email=t),label:"Email",placeholder:"example@example.com","input-class":"w-full",errors:s.errors.email,onInput:r.debounceSuggestions},null,8,["modelValue","errors","onInput"])])):b("",!0),s.newMember.id||s.newMember.person_id?(n(),a("div",me,[o(u,{label:"Name"},{default:d(()=>[g(_(s.newMember.person.name),1)]),_:1}),o(u,{label:"Email"},{default:d(()=>[g(_(s.newMember.person.email),1)]),_:1}),o(u,{label:"Institution"},{default:d(()=>[g(_(s.newMember.person.institution?s.newMember.person.institution.name:"--"),1)]),_:1}),o(u,{label:"Credentials"},{default:d(()=>[o(E,{person:s.newMember.person},null,8,["person"])]),_:1}),o(u,{label:"Expertise"},{default:d(()=>[o(A,{person:s.newMember.person,"legacy-expertise":s.newMember.legacy_expertise},null,8,["person","legacy-expertise"])]),_:1}),s.newMember.id?b("",!0):(n(),h(N,{key:0},{default:d(()=>[g(" Adding existing person, "+_(s.newMember.person.name)+", as a group member. ",1)]),_:1})),s.newMember.id?(n(),h(u,{key:1,label:"",class:"text-sm"},{default:d(()=>[o(F,{content:"As a coordinator you can edit some attributes of a group member's profile including name, email, institution, and credentials.",hover:"",arrow:""},{default:d(()=>[l("button",{class:"link text-sm",onClick:e[5]||(e[5]=t=>s.showProfileForm=!0)}," Edit profile attributes ")]),_:1})]),_:1})):b("",!0),s.newMember.id?b("",!0):(n(),h(R,{key:2},{default:d(()=>e[15]||(e[15]=[g(" You can edit the member's profile attributes from here once you've added them to your group. ")])),_:1}))])):b("",!0),o(w,{label:"Notes",errors:s.errors.notes},{default:d(()=>[x(l("textarea",{"onUpdate:modelValue":e[6]||(e[6]=t=>s.newMember.notes=t),rows:"5",class:"w-full"},null,512),[[P,s.newMember.notes]])]),_:1},8,["errors"]),o(u,{label:""},{default:d(()=>[o(f,{"model-value":i.roleRequiresNotification||s.newMember.is_contact,disabled:i.roleRequiresNotification,label:"Receives notifications about this group","onUpdate:modelValue":e[7]||(e[7]=t=>s.newMember.is_contact=t)},null,8,["model-value","disabled"])]),_:1}),l("div",ue,[e[17]||(e[17]=l("h3",null,"Group Roles",-1)),l("div",pe,[(n(!0),a(v,null,y(m.roles,t=>(n(),h(f,{key:t.id,modelValue:s.newMember.roles,"onUpdate:modelValue":e[8]||(e[8]=M=>s.newMember.roles=M),value:t,label:r.titleCase(t.name),onInput:i.handleRoleChange},null,8,["modelValue","value","label","onInput"]))),128))]),o(k,{name:"fade-down"},{default:d(()=>[s.newMember.hasRole("biocurator")&&m.group.is_vcep?(n(),a("div",be,[e[16]||(e[16]=l("h4",null,"Training",-1)),(n(),a(v,null,y([1,2],t=>o(f,{key:t,modelValue:s.newMember[`training_level_${t}`],"onUpdate:modelValue":M=>s.newMember[`training_level_${t}`]=M,value:1,label:`Level ${t}`},null,8,["modelValue","onUpdate:modelValue","label"])),64))])):b("",!0)]),_:1})]),o(q,{class:"border-t mt-4 pt-2 mb-2"},{title:d(()=>[l("h3",ce,[e[18]||(e[18]=g(" Group Permissions ")),s.newMember.permissions.length>0?(n(),h(U,{key:0,color:"gray"},{default:d(()=>[g(_(s.newMember.permissions.length),1)]),_:1})):b("",!0)])]),default:d(()=>[l("div",ge,[(n(!0),a(v,null,y(m.permissions,t=>(n(),h(f,{id:`permission-${t.id}`,key:t.id,modelValue:s.newMember.permissions,"onUpdate:modelValue":e[9]||(e[9]=M=>s.newMember.permissions=M),value:t,disabled:s.newMember.hasPermissionThroughRole(t),checked:s.newMember.hasPermissionThroughRole(t),title:s.newMember.hasPermissionThroughRole(t)?"granted with role":"grant permission",label:t.display_name},null,8,["id","modelValue","value","disabled","checked","title","label"]))),128))]),l("div",we,[l("div",he,[e[19]||(e[19]=l("strong",null,"Legend: ",-1)),o(f,{label:"Not granted"}),o(f,{modelValue:s.legendValues,"onUpdate:modelValue":e[10]||(e[10]=t=>s.legendValues=t),value:1,label:"Granted"},null,8,["modelValue"]),o(f,{modelValue:s.legendValues,"onUpdate:modelValue":e[11]||(e[11]=t=>s.legendValues=t),value:2,disabled:"",label:"Granted w/ role"},null,8,["modelValue"])]),e[20]||(e[20]=l("div",{class:"absolute top-0 left-0 w-full h-full bg-pink-500 opacity-0"},"   ",-1))])]),_:1})]),o(k,{name:"slide-fade"},{default:d(()=>[s.suggestedPeople.length>0&&s.newMember.person_id===null?(n(),a("div",_e,[e[21]||(e[21]=l("h5",{class:"font-bold border-b mb-1 pb-1"}," Matching people ",-1)),o(G,{suggestions:s.suggestedPeople,onSelected:i.useExistingPerson},null,8,["suggestions","onSelected"])])):b("",!0)]),_:1})]),l("div",null,[o(T,{"submit-text":"Save",style:{"margin-top":"0"},onSubmit:i.saveAndExit,onCancel:i.cancel},{"extra-buttons":d(()=>[s.newMember.id?b("",!0):(n(),a("button",{key:0,class:"btn blue",onClick:e[12]||(e[12]=(...t)=>i.saveAndEditProfile&&i.saveAndEditProfile(...t))}," Save and edit profle "))]),_:1},8,["onSubmit","onCancel"])])]),(n(),h(z,{to:"body"},[o(L,{modelValue:s.showProfileForm,"onUpdate:modelValue":e[14]||(e[14]=t=>s.showProfileForm=t),title:"Edit Member Profile"},{default:d(()=>[i.needsCredentials||i.needsExpertise?(n(),a("div",fe,[e[24]||(e[24]=g(" We need updated ")),i.needsCredentials?(n(),a("strong",Me,"credentials")):b("",!0),i.needsExpertise&&i.needsCredentials?(n(),a("span",ve,"and")):b("",!0),i.needsExpertise?(n(),a("strong",ye,"expertise")):b("",!0),e[25]||(e[25]=g(" information for this member. ")),i.needsCredentials&&s.newMember.person.legacy_credentials?(n(),a("div",xe,[e[22]||(e[22]=l("strong",null,"Legacy Credentials Data:",-1)),g(" "+_(s.newMember.person.legacy_credentials),1)])):b("",!0),i.needsExpertise&&s.newMember.legacy_expertise?(n(),a("div",Pe,[e[23]||(e[23]=l("strong",null,"Legacy Expertise Data:",-1)),g(" "+_(s.newMember.legacy_expertise),1)])):b("",!0)])):b("",!0),s.newMember.person?(n(),h(D,{key:1,person:s.newMember.person,onSaved:i.handleProfileUpdate,onCanceled:e[13]||(e[13]=t=>s.showProfileForm=!1)},null,8,["person","onSaved"])):b("",!0)]),_:1},8,["modelValue"])]))],64)}const Ce=C(ne,[["render",Ve],["__scopeId","data-v-fbef26e5"]]);export{Ce as default};
//# sourceMappingURL=MemberForm-BZSfcngq.js.map
