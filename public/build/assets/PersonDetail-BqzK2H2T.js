import{_ as M,G,a as n,c as g,b as u,f as t,a2 as U,d as s,i as d,w as l,h as _,e as P,j as p,F as N,m as $,a9 as B,a1 as D,B as q,ap as O,aa as H}from"./app-DNJR23u9.js";import{f as Y,l as z}from"./log_entry_repository-BcZgjvxE.js";import{C as J,P as K}from"./CoiList-D9URCwDq.js";import{A as Q}from"./ActivityLog-Q_9Dzunm.js";import{C as W}from"./CustomEmailForm-DpklXZx2.js";import{P as X}from"./CoiDetail-BaSKvLa1.js";import Z from"./DemographicsForm-C_08HEtM.js";import"./ProfileForm-BFsC82_B.js";import"./ExpertisesView-JAlCyZ4p.js";const x={name:"MembershipList",props:{person:{type:Object,required:!0}},data(){return{sort:{field:"group.displayName",desc:!1},fields:[{name:"group.displayName",type:String,sortable:!0,label:"Name"},{name:"group.type.name",type:String,sortable:!0,label:"Type"},{name:"roles",type:String,sortable:!1,label:"Roles",resolveValue(e){return e.roles.map(o=>o.name).join(", ")}},{name:"permissions",type:String,sortable:!1,label:"Permissions",resolveValue(e){return e.permissions.map(o=>o.name).join(", ")}},{name:"start_date",type:Date,sortable:!0,label:"Started"},{name:"end_date",type:Date,sortable:!0,label:"Ended"}]}},computed:{memberships(){return this.person.memberships?this.person.memberships.map(e=>(e.group&&(e.group=new G(e.group)),e)):[]}},methods:{goToGroup(e){this.$router.push({name:"GroupDetail",params:{uuid:e.group.uuid}})}}};function ee(e,o,c,C,i,r){const f=n("data-table");return u(),g("div",null,[t(f,{sort:i.sort,"onUpdate:sort":o[0]||(o[0]=h=>i.sort=h),fields:i.fields,data:r.memberships,"row-click-handler":r.goToGroup,"row-class":()=>"cursor-pointer"},null,8,["sort","fields","data","row-click-handler"])])}const oe=M(x,[["render",ee]]),te={name:"PersonMergeForm",props:{authority:{type:Object,required:!1},obsolete:{type:Object,default:()=>({})}},emits:["saved","canceled"],data(){return{authorityCopy:null,obsoleteCopy:null,errors:{}}},watch:{authority:{immediate:!0,handler(e){e&&(this.authorityCopy={...e.attributes})}},obsolete:{immediate:!0,handler(e){e&&(this.obsoleteCopy={...e.attributes})}}},methods:{async commitMerge(){try{this.errors={},await this.$store.dispatch("people/mergePeople",{authority:this.authorityCopy,obsolete:this.obsoleteCopy}),this.authorityId=null,this.obsoleteIds=null,this.$emit("saved")}catch(e){U(e)&&(this.errors=e.response.data.errors)}},cancelMerge(){this.authorityId=null,this.obsoleteId=null,this.$emit("canceled")}}};function se(e,o,c,C,i,r){const f=n("note"),h=n("person-search-select"),a=n("input-row"),m=n("button-row");return u(),g("div",null,[o[6]||(o[6]=s("p",{class:"mb-8"},[d(" Merging peple will do the following: "),s("ol",{class:"list-decimal ml-6"},[s("li",null,"Add the authoritative person to all groups of which the obsolete person is a member."),s("li",null,"Delete the obsolete person, their memberships, their invite, and their user account (if activated).")])],-1)),t(a,{label:"Merge",vertical:""},{label:l(()=>[o[3]||(o[3]=d(" Merge ")),t(f,{class:"inline-block"},{default:l(()=>o[2]||(o[2]=[d(" (Obsolete person that will be deleted) ")])),_:1})]),default:l(()=>[t(h,{modelValue:i.obsoleteCopy,"onUpdate:modelValue":o[0]||(o[0]=w=>i.obsoleteCopy=w),"allow-add":!1},null,8,["modelValue"])]),_:1}),t(a,{label:"Into",errors:i.errors.authority_id,vertical:""},{label:l(()=>[o[5]||(o[5]=d(" Into ")),t(f,{class:"inline"},{default:l(()=>o[4]||(o[4]=[d(" (Authoritative person) ")])),_:1})]),default:l(()=>[t(h,{modelValue:i.authorityCopy,"onUpdate:modelValue":o[1]||(o[1]=w=>i.authorityCopy=w),"allow-add":!1},null,8,["modelValue"])]),_:1},8,["errors"]),t(m,{"submit-text":"Merge",onSubmitted:r.commitMerge,onCanceled:r.cancelMerge},null,8,["onSubmitted","onCanceled"])])}const ne=M(te,[["render",se]]),re={name:"PersonMailLog",components:{CustomEmailForm:W},props:{person:{type:Object,required:!0},mail:{type:Array,required:!0}},data(){return{currentEmail:{},showResendDialog:null}},computed:{},methods:{initResend(e){this.currentEmail={...e},this.showResendDialog=!0},cleanupResend(){this.currentEmail={},this.showResendDialog=!1,this.$store.dispatch("people/getMail",this.person)}}},le={key:0,class:"well"},ie={key:0},ae={key:1},de={class:"mt-1"},ue=["innerHTML"],pe=["onClick"];function me(e,o,c,C,i,r){const f=n("CustomEmailForm"),h=n("modal-dialog");return u(),g("div",null,[c.mail.length==0?(u(),g("div",le,p(c.person.first_name)+" has not received any mail via the GPM. ",1)):_("",!0),(u(!0),g(N,null,$(c.mail,a=>(u(),g("div",{key:a.id,class:"w-3/4 my-4 p-4 border"},[o[5]||(o[5]=s("span",{class:"text-gray-600"},"Sent at",-1)),d(" "+p(e.formatDate(a.created_at))+" ",1),s("div",null,[o[1]||(o[1]=s("span",{class:"text-gray-600"},"To:",-1)),d(" "+p(a.to.map(m=>m.address).join(", ")),1)]),a.cc?(u(),g("div",ie,[o[2]||(o[2]=s("span",{class:"text-gray-600"},"CC:",-1)),d(" "+p(a.cc.map(m=>m.address).join(", ")),1)])):_("",!0),a.bcc?(u(),g("div",ae,[o[3]||(o[3]=s("span",{class:"text-gray-600"},"BCC:",-1)),d(" "+p(a.bcc.map(m=>m.address).join(", ")),1)])):_("",!0),s("div",de,[o[4]||(o[4]=s("span",{class:"text-gray-600"},"Subject:",-1)),d(" "+p(a.subject),1)]),o[6]||(o[6]=s("hr",null,null,-1)),s("div",{innerHTML:a.body},null,8,ue),o[7]||(o[7]=s("hr",null,null,-1)),e.hasPermission("people-manage")||e.coordinatesPerson(c.person)?(u(),g("button",{key:2,class:"btn btn-xs",onClick:B(m=>r.initResend(a),["stop"])}," Resend ",8,pe)):_("",!0)]))),128)),(u(),P(D,{to:"body"},[t(h,{modelValue:i.showResendDialog,"onUpdate:modelValue":o[0]||(o[0]=a=>i.showResendDialog=a),title:"Resend Email"},{default:l(()=>[t(f,{"mail-data":i.currentEmail,onSent:r.cleanupResend,onCanceled:r.cleanupResend},null,8,["mail-data","onSent","onCanceled"])]),_:1},8,["modelValue"])]))])}const ge=M(re,[["render",me]]),he={name:"PersonDetail",components:{TabsContainer:O,MembershipList:oe,PersonProfile:K,DemographicsForm:Z,PersonMergeForm:ne,CoiList:J,ActivityLog:Q,PersonMailLog:ge,ProfilePicture:X},props:{uuid:{required:!0,type:String}},data(){return{showDeleteConfirmation:!1,showMergeForm:!1,mailLoading:!1,logsLoading:!1}},watch:{uuid:{immediate:!0,async handler(){await this.$store.dispatch("people/getPerson",{uuid:this.uuid}),this.coordinatesPerson(this.person)&&(this.getLogEntries(),this.getMailLog())}},"person.memberships":function(e){e.length>0&&(this.getLogEntries(),this.getMailLog())}},computed:{...q({person:"people/currentItem"}),showModal:{get(){return this.$route.meta.showModal},set(e){e&&this.$router.push({name:"PersonEdit",params:{uuid:this.person.uuid}}),this.$router.push({name:"PersonDetail",params:{uuid:this.person.uuid}})}},sortedMailLog(){return[...this.person.mailLog].sort((e,o)=>e.created_at===o.created_at?0:Date.parse(e.created_at)>Date.parse(o.created_at)?-1:1)}},methods:{initDelete(){this.showDeleteConfirmation=!0},async commitDelete(){await this.$store.dispatch("people/deletePerson",this.person),this.showDeleteConfirmation=!1,this.$router.go(-1)},cancelDelete(){this.showDeleteConfirmation=!1},initMerge(){this.showMergeForm=!0},handleMerged(){this.showMergeForm=!1,this.$router.go(-1)},handleMergeCanceled(){this.showMergeForm=!1},async getMailLog(){this.mailLoading=!0,await this.$store.dispatch("people/getMail",this.person),this.mailLoading=!1},async getLogEntries(){this.logsLoading=!0,await this.fetchEntries(`/api/people/${this.uuid}/activity-logs`),this.logsLoading=!1}},setup(){return{formatDate:H,logEntries:z,fetchEntries:Y}},onmounted(){this.$store.dispatch("people/clearCurrentItem")}},be={class:"pb-4"},ce={class:"flex space-x-4"},fe={class:"flex-1"},ye={class:"flex justify-between items-center"},we={class:"flex space-x-4 items-center"},_e={class:"flex space-x-4 items-center"},Ce={class:"border my-4 p-4 bg-red-100 border-red-200 rounded"};function Me(e,o,c,C,i,r){const f=n("ProfilePicture"),h=n("router-link"),a=n("note"),m=n("icon-edit"),w=n("dictionary-row"),V=n("MembershipList"),y=n("tab-item"),E=n("PersonProfile"),k=n("DemographicsForm"),F=n("CoiList"),L=n("refresh-button"),S=n("PersonMailLog"),I=n("ActivityLog"),R=n("TabsContainer"),j=n("router-view"),v=n("modal-dialog"),T=n("button-row"),A=n("PersonMergeForm");return u(),g("div",null,[s("header",be,[s("div",ce,[t(f,{person:e.person,style:{width:"155px"},class:"rounded-lg"},null,8,["person"]),s("div",fe,[t(h,{class:"note",to:"/people"},{default:l(()=>o[5]||(o[5]=[d(" People ")])),_:1}),s("h1",ye,[s("div",null,[d(p(e.person.name)+" ",1),t(a,null,{default:l(()=>[d("ID: "+p(e.person.id),1)]),_:1})]),e.hasPermission("people-manage")||e.userIsPerson(e.person)||e.coordinatesPerson(e.person)?(u(),P(h,{key:0,to:`/people/${c.uuid}/edit`,class:"btn btn-xs flex-grow-0"},{default:l(()=>[t(m,{width:"16",heigh:"16"})]),_:1},8,["to"])):_("",!0)]),t(w,{label:"Email","label-class":"w-24 font-bold"},{default:l(()=>[d(p(e.person.email),1)]),_:1}),t(w,{label:"Institution","label-class":"w-24 font-bold"},{default:l(()=>[d(p(e.person.institution?e.person.institution.name:null),1)]),_:1})])])]),t(R,null,{default:l(()=>[t(y,{label:"groups"},{default:l(()=>[o[6]||(o[6]=s("h2",null,"Groups",-1)),t(V,{person:e.person},null,8,["person"])]),_:1}),t(y,{label:"Info"},{default:l(()=>[o[7]||(o[7]=s("h2",null,"Profile",-1)),t(E,{person:e.person},null,8,["person"])]),_:1}),t(y,{label:"Demographics",visible:e.hasRole("super-admin")||e.userIsPerson(e.person)},{default:l(()=>[t(k,{person:e.person},null,8,["person"])]),_:1},8,["visible"]),t(y,{label:"Conflict of Interest"},{default:l(()=>[t(F,{person:e.person},null,8,["person"])]),_:1}),t(y,{label:"Email Log",visible:e.hasPermission("people-manage")||e.userIsPerson(e.person)||e.coordinatesPerson(e.person)},{default:l(()=>[s("header",we,[s("h2",null,"Mail sent to "+p(e.person.first_name),1),t(L,{loading:i.mailLoading,onClick:r.getMailLog},null,8,["loading","onClick"])]),t(S,{person:e.person,mail:r.sortedMailLog},null,8,["person","mail"])]),_:1},8,["visible"]),t(y,{label:"Log",visible:e.hasPermission("people-manage")||e.coordinatesPerson(e.person)},{default:l(()=>[s("div",_e,[o[8]||(o[8]=s("h2",null,"Log Entries",-1)),t(L,{loading:i.logsLoading,onClick:r.getLogEntries},null,8,["loading","onClick"])]),t(I,{"log-entries":C.logEntries,"api-url":`/api/people/${e.person.uuid}/activity-logs`,"log-updated":r.getLogEntries},null,8,["log-entries","api-url","log-updated"])]),_:1},8,["visible"]),t(y,{label:"Admin",visible:e.hasPermission("people-manage")},{default:l(()=>[s("section",Ce,[o[9]||(o[9]=s("h2",{class:"mb-4 text-red-800"}," Here be dragons. Proceed with caution. ",-1)),s("p",null,[s("button",{class:"btn btn red",onClick:o[0]||(o[0]=(...b)=>r.initMerge&&r.initMerge(...b))}," Merge Person into another ")]),s("p",null,[s("button",{class:"btn btn red",onClick:o[1]||(o[1]=(...b)=>r.initDelete&&r.initDelete(...b))}," Delete Person ")])])]),_:1},8,["visible"])]),_:1}),(u(),P(D,{to:"body"},[t(v,{modelValue:r.showModal,"onUpdate:modelValue":o[2]||(o[2]=b=>r.showModal=b),title:e.$route.meta.title},{default:l(()=>[t(j,{name:"modal"})]),_:1},8,["modelValue","title"]),t(v,{modelValue:i.showDeleteConfirmation,"onUpdate:modelValue":o[3]||(o[3]=b=>i.showDeleteConfirmation=b),title:`You are about to delete ${e.person.name}`},{default:l(()=>[o[10]||(o[10]=s("p",null,"You are about to delete this person. All related data will also be deleted including:",-1)),o[11]||(o[11]=s("ul",{class:"list-disc pl-6"},[s("li",null,"User record, system roles, and system permissions (if account is activated)"),s("li",null,"Invite"),s("li",null,"Group Memberships and group roles (if any)")],-1)),o[12]||(o[12]=s("div",{class:"border my-4 px-2 py-1 font-bold bg-red-100 border-red-200 rounded text-red-800"}," This cannot be undone. ",-1)),t(T,{"submit-text":`Delete ${e.person.name}`,"submit-variant":"red",onSubmitted:r.commitDelete,onCanceled:r.cancelDelete},null,8,["submit-text","onSubmitted","onCanceled"])]),_:1},8,["modelValue","title"]),t(v,{modelValue:i.showMergeForm,"onUpdate:modelValue":o[4]||(o[4]=b=>i.showMergeForm=b),title:`Merge ${e.person.name} into another person`},{default:l(()=>[t(A,{obsolete:e.person,onSaved:r.handleMerged,onCanceled:r.handleMergeCanceled},null,8,["obsolete","onSaved","onCanceled"])]),_:1},8,["modelValue","title"])]))])}const Ie=M(he,[["render",Me]]);export{Ie as default};
//# sourceMappingURL=PersonDetail-BqzK2H2T.js.map
