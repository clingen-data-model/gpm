{"version":3,"file":"UserDetail-wU8ZSieJ.js","sources":["../../../resources/js/views/users/UserDetail.vue"],"sourcesContent":["<script>\nimport User from '@/domain/user'\nimport {api} from '@/http'\nimport configs from '@/configs'\n\nexport default {\n    name: 'UserDetail',\n    props: {\n        id: {\n            require: true\n        }\n    },\n    data() {\n        return {\n            user: new User(),\n            membershipFields: [\n                {name: 'id'},\n                {name: 'group'},\n                {name: 'roles'},\n                {name: 'extra_permissions'}\n            ],\n            showEditForm: false,\n            systemRoles: [],\n            systemPermissions: Object.values(configs.system.permissions),\n            configs,\n            checkedRoles: [],\n            checkedPermissions: [],\n        }\n    },\n    computed: {\n        userInfo () {\n            return {\n                name: this.user.person.name,\n                email: this.user.person.email,\n                roles: this.user.roles.map(r => r.name).join(', '),\n                additional_permissions: this.user.permissions.map(r => r.name).join(', '),\n                registered: this.formatDate(this.user.created_at),\n            }\n        },\n        membershipInfo () {\n            return this.user.person.memberships.map(m => ({\n                    id: m.id,\n                    group: m.group.display_name,\n                    roles: m.roles.map(r => r.name).join(', '),\n                    extra_permissions: m.permissions.map(r => r.name).join(', ') || '',\n                    is_contact: m.is_contact ? 'Yes' : 'No',\n                }))\n        },\n        checkedRolePermissionIds () {\n            if (!this.systemRoles) {\n                return [];\n            }\n            const checkedRolePerms = this.systemRoles\n                                        .filter(r => this.checkedRoles.includes(r.id))\n                                        .map(r => r.permissions)\n                                        .flat()\n                                        .map(p => p.id);\n            return [...(new Set(checkedRolePerms))];\n        },\n        availableSystemRoles () {\n            return this.systemRoles.filter(r => {\n                if (this.hasRole('super-user')) return true;\n                if (this.hasRole('super-admin')) {\n                    if (r.name === 'super-user') return false;\n                    return true;\n                }\n                return false;\n            });\n        },\n        availableSystemPermissions () {\n            return this.systemPermissions.filter(p => {\n                if (this.hasRole('super-user')) return true;\n                if (this.hasRole('super-admin')) {\n                    if (p.name === 'logs-view') return false;\n                    return true;\n                }\n                return false;\n            });\n        },\n        canEditUser () {\n            const currentUser = this.$store.getters.currentUser;\n            if (!this.hasPermission('users-manage')) {\n                return false;\n            }\n\n            if (this.currentUserIsUser) {\n                return true;\n            }\n\n            if (currentUser.hasRole('super-user')) {\n                return true;\n            }\n\n            if (currentUser.hasRole('super-admin') && (this.user.hasRole('admin') || this.user.hasNoRole())) {\n                return true;\n            }\n\n            return false;\n\n        },\n        currentUserIsUser () {\n            return Number.parseInt(this.$store.getters.currentUser.id) === Number.parseInt(this.user.id);\n        }\n    },\n    watch: {\n        id: {\n            immediate: true,\n            handler () {\n                this.getUser();\n            }\n        }\n    },\n    mounted () {\n        this.getSystemRoles();\n    },\n    methods: {\n        async getUser () {\n            this.user = await api.get(`/api/users/${this.id}`)\n                            .then(response => {\n                                return new User(response.data)\n                            });\n            this.resetCheckedRolesAndPermissions();\n        },\n        resetCheckedRolesAndPermissions () {\n            this.checkedRoles = this.user.roles.map(r => r.id);\n            this.checkedPermissions = this.user.permissions.map(r => r.id);\n        },\n        async getSystemRoles () {\n            this.systemRoles = await api.get(`/api/roles`)\n                                .then(response => response.data);\n        },\n        initEdit () {\n            this.showEditForm = true;\n        },\n        async saveRolesAndPermissions () {\n            const payload = {\n                role_ids: this.checkedRoles,\n                permission_ids: this.checkedPermissions\n            };\n\n            await api.put(`/api/users/${this.user.id}/roles-and-permissions`, payload);\n            this.showEditForm = false;\n\n            this.getUser();\n\n        },\n        closeEditForm () {\n            this.resetCheckedRolesAndPermissions();\n            this.showEditForm = false;\n        }\n    }\n}\n</script>\n<template>\n  <div>\n    <h1>{{ user.person.name || 'loading...' }}</h1>\n\n    <object-dictionary :obj=\"userInfo\" />\n    <button v-if=\"canEditUser\" class=\"btn btn-xs\" @click=\"initEdit\">\n      Edit system roles &amp; permissions\n    </button>\n\n    <h2 class=\"mt-8 mb-2\">\n      Memberships\n    </h2>\n    <data-table :fields=\"membershipFields\" :data=\"membershipInfo\" />\n\n    <teleport to=\"body\">\n      <modal-dialog\n        v-model=\"showEditForm\"\n        title=\"Edit System Roles & Permissions\"\n      >\n        <h3 class=\"border-b mb-1\">\n          Roles\n        </h3>\n        <ul class=\"flex flex-wrap\">\n          <li v-for=\"role in availableSystemRoles\" :key=\"role.id\" class=\"w-1/3 h-12\">\n            <checkbox v-model=\"checkedRoles\" :label=\"titleCase(role.display_name)\" :value=\"role.id\" />\n          </li>\n        </ul>\n\n        <h3 class=\"border-b mb-1\">\n          Permissions\n        </h3>\n        <ul class=\"flex flex-wrap\">\n          <li v-for=\"permission in availableSystemPermissions\" :key=\"permission.id\" class=\"w-1/3 h-12\">\n            <checkbox\n              v-if=\"checkedRolePermissionIds.includes(permission.id)\"\n              :model-value=\"true\" :disabled=\"true\" :label=\"permission.display_name\"\n            />\n            <checkbox\n              v-else\n              v-model=\"checkedPermissions\"\n              :label=\"titleCase(permission.display_name)\"\n              :value=\"permission.id\"\n            />\n          </li>\n        </ul>\n\n        <div class=\"px-2 py-1 mb-2 mt-4 bg-gray-100 border relative text-xs\">\n          <div class=\"flex space-x-2\">\n            <strong>Legend: </strong>\n            <checkbox label=\"Not granted\" />\n            <checkbox :value=\"1\" :model-value=\"true\" label=\"Granted\" />\n            <checkbox :value=\"2\" :model-value=\"true\" disabled label=\"Granted w/ role\" />\n          </div>\n          <div class=\"absolute top-0 left-0 w-full h-full bg-pink-500 opacity-0\">\n&nbsp;\n          </div>\n        </div>\n\n        <button-row\n          submit-text=\"Save\"\n          @submitted=\"saveRolesAndPermissions\"\n          @canceled=\"closeEditForm\"\n        />\n      </modal-dialog>\n    </teleport>\n  </div>\n</template>\n"],"names":["_sfc_main","User","configs","r","m","checkedRolePerms","p","currentUser","api","response","payload","_hoisted_1","_hoisted_2","_hoisted_3","_hoisted_4","_createElementBlock","_createElementVNode","_toDisplayString","$data","_createVNode","_component_object_dictionary","$options","args","_createCommentVNode","_cache","_component_data_table","_createBlock","_Teleport","_component_modal_dialog","$event","_withCtx","_openBlock","_Fragment","_renderList","role","_component_checkbox","_ctx","permission","_component_button_row"],"mappings":"iJAKA,MAAKA,EAAU,CACX,KAAM,aACN,MAAO,CACH,GAAI,CACA,QAAS,EACb,CACH,EACD,MAAO,CACH,MAAO,CACH,KAAM,IAAIC,EACV,iBAAkB,CACd,CAAC,KAAM,IAAI,EACX,CAAC,KAAM,OAAO,EACd,CAAC,KAAM,OAAO,EACd,CAAC,KAAM,mBAAmB,CAC7B,EACD,aAAc,GACd,YAAa,CAAE,EACf,kBAAmB,OAAO,OAAOC,EAAQ,OAAO,WAAW,EAC3D,QAAAA,EACA,aAAc,CAAE,EAChB,mBAAoB,CAAE,CAC1B,CACH,EACD,SAAU,CACN,UAAY,CACR,MAAO,CACH,KAAM,KAAK,KAAK,OAAO,KACvB,MAAO,KAAK,KAAK,OAAO,MACxB,MAAO,KAAK,KAAK,MAAM,IAAIC,GAAKA,EAAE,IAAI,EAAE,KAAK,IAAI,EACjD,uBAAwB,KAAK,KAAK,YAAY,IAAIA,GAAKA,EAAE,IAAI,EAAE,KAAK,IAAI,EACxE,WAAY,KAAK,WAAW,KAAK,KAAK,UAAU,CACpD,CACH,EACD,gBAAkB,CACd,OAAO,KAAK,KAAK,OAAO,YAAY,IAAIC,IAAM,CACtC,GAAIA,EAAE,GACN,MAAOA,EAAE,MAAM,aACf,MAAOA,EAAE,MAAM,IAAID,GAAKA,EAAE,IAAI,EAAE,KAAK,IAAI,EACzC,kBAAmBC,EAAE,YAAY,IAAID,GAAKA,EAAE,IAAI,EAAE,KAAK,IAAI,GAAK,GAChE,WAAYC,EAAE,WAAa,MAAQ,IACvC,EAAE,CACT,EACD,0BAA4B,CACxB,GAAI,CAAC,KAAK,YACN,MAAO,CAAE,EAEb,MAAMC,EAAmB,KAAK,YACD,OAAOF,GAAK,KAAK,aAAa,SAASA,EAAE,EAAE,CAAC,EAC5C,IAAIA,GAAKA,EAAE,WAAW,EACtB,KAAI,EACJ,IAAIG,GAAKA,EAAE,EAAE,EAC1C,MAAO,CAAC,GAAI,IAAI,IAAID,CAAgB,CAAE,CACzC,EACD,sBAAwB,CACpB,OAAO,KAAK,YAAY,OAAOF,GACvB,KAAK,QAAQ,YAAY,EAAU,GACnC,KAAK,QAAQ,aAAa,EACtBA,EAAE,OAAS,aAGZ,EACV,CACJ,EACD,4BAA8B,CAC1B,OAAO,KAAK,kBAAkB,OAAOG,GAC7B,KAAK,QAAQ,YAAY,EAAU,GACnC,KAAK,QAAQ,aAAa,EACtBA,EAAE,OAAS,YAGZ,EACV,CACJ,EACD,aAAe,CACX,MAAMC,EAAc,KAAK,OAAO,QAAQ,YACxC,OAAK,KAAK,cAAc,cAAc,EAIlC,QAAK,mBAILA,EAAY,QAAQ,YAAY,GAIhCA,EAAY,QAAQ,aAAa,IAAM,KAAK,KAAK,QAAQ,OAAO,GAAK,KAAK,KAAK,UAAW,IAXnF,EAiBd,EACD,mBAAqB,CACjB,OAAO,OAAO,SAAS,KAAK,OAAO,QAAQ,YAAY,EAAE,IAAM,OAAO,SAAS,KAAK,KAAK,EAAE,CAC/F,CACH,EACD,MAAO,CACH,GAAI,CACA,UAAW,GACX,SAAW,CACP,KAAK,QAAS,CAClB,CACJ,CACH,EACD,SAAW,CACP,KAAK,eAAgB,CACxB,EACD,QAAS,CACL,MAAM,SAAW,CACb,KAAK,KAAO,MAAMC,EAAI,IAAI,cAAc,KAAK,EAAE,EAAE,EAChC,KAAKC,GACK,IAAIR,EAAKQ,EAAS,IAAI,CAChC,EACjB,KAAK,gCAAiC,CACzC,EACD,iCAAmC,CAC/B,KAAK,aAAe,KAAK,KAAK,MAAM,IAAIN,GAAKA,EAAE,EAAE,EACjD,KAAK,mBAAqB,KAAK,KAAK,YAAY,IAAIA,GAAKA,EAAE,EAAE,CAChE,EACD,MAAM,gBAAkB,CACpB,KAAK,YAAc,MAAMK,EAAI,IAAI,YAAY,EACxB,KAAKC,GAAYA,EAAS,IAAI,CACtD,EACD,UAAY,CACR,KAAK,aAAe,EACvB,EACD,MAAM,yBAA2B,CAC7B,MAAMC,EAAU,CACZ,SAAU,KAAK,aACf,eAAgB,KAAK,kBACxB,EAED,MAAMF,EAAI,IAAI,cAAc,KAAK,KAAK,EAAE,yBAA0BE,CAAO,EACzE,KAAK,aAAe,GAEpB,KAAK,QAAS,CAEjB,EACD,eAAiB,CACb,KAAK,gCAAiC,EACtC,KAAK,aAAe,EACxB,CACJ,CACJ,EAwBYC,EAAA,CAAA,MAAM,gBAAgB,EAStBC,EAAA,CAAA,MAAM,gBAAgB,EAerBC,EAAA,CAAA,MAAM,yDAAyD,EAC7DC,EAAA,CAAA,MAAM,gBAAgB,4IA9CnCC,EAgEM,MAAA,KAAA,CA/DJC,EAA+C,KAAxC,KAAAC,EAAAC,EAAA,KAAK,OAAO,MAAI,YAAA,EAAA,CAAA,EAEvBC,EAAqCC,EAAA,CAAjB,IAAKC,EAAQ,QAAA,EAAA,KAAA,EAAA,CAAA,KAAA,CAAA,EACnBA,EAAW,iBAAzBN,EAES,SAAA,CAhKb,IAAA,EA8J+B,MAAM,aAAc,4BAAOM,EAAQ,UAAAA,EAAA,SAAA,GAAAC,CAAA,IAAE,mCAEhE,GAhKJC,EAAA,GAAA,EAAA,EAkKIC,EAAA,CAAA,IAAAA,EAAA,CAAA,EAAAR,EAEK,KAFD,CAAA,MAAM,WAAW,EAAC,gBAEtB,EAAA,GACAG,EAAgEM,EAAA,CAAnD,OAAQP,EAAgB,iBAAG,KAAMG,EAAc,+CAE5DK,EAkDWC,EAAA,CAlDD,GAAG,MAAM,EAAA,CACjBR,EAgDeS,EAAA,CAxNrB,WAyKiBV,EAAY,aAzK7B,sBAAAM,EAAA,CAAA,IAAAA,EAAA,CAAA,EAAAK,GAyKiBX,EAAY,aAAAW,GACrB,MAAM,oCA1Kd,QAAAC,EA4KQ,IAEK,CAFLN,EAAA,CAAA,IAAAA,EAAA,CAAA,EAAAR,EAEK,KAFD,CAAA,MAAM,eAAe,EAAC,UAE1B,EAAA,GACAA,EAIK,KAJLL,EAIK,EAHHoB,EAAA,EAAA,EAAAhB,EAEKiB,EAlLf,KAAAC,EAgL6BZ,EAAoB,qBAA5Ba,QAAXnB,EAEK,KAAA,CAFqC,IAAKmB,EAAK,GAAI,MAAM,eAC5Df,EAA0FgB,EAAA,CAjLtG,WAiL+BjB,EAAY,aAjL3C,sBAAAM,EAAA,CAAA,IAAAA,EAAA,CAAA,EAAAK,GAiL+BX,EAAY,aAAAW,GAAG,MAAOO,EAAA,UAAUF,EAAK,YAAY,EAAI,MAAOA,EAAK,uDAIxFV,EAAA,CAAA,IAAAA,EAAA,CAAA,EAAAR,EAEK,KAFD,CAAA,MAAM,eAAe,EAAC,gBAE1B,EAAA,GACAA,EAaK,KAbLJ,EAaK,EAZHmB,EAAA,EAAA,EAAAhB,EAWKiB,EApMf,KAAAC,EAyLmCZ,EAA0B,2BAAxCgB,QAAXtB,EAWK,KAAA,CAXiD,IAAKsB,EAAW,GAAI,MAAM,eAEtEhB,EAAA,yBAAyB,SAASgB,EAAW,EAAE,OADvDX,EAGES,EAAA,CA7Ld,IAAA,EA4Le,cAAa,GAAO,SAAU,GAAO,MAAOE,EAAW,sCAE1DX,EAKES,EAAA,CAnMd,IAAA,EAAA,WAgMuBjB,EAAkB,mBAhMzC,sBAAAM,EAAA,CAAA,IAAAA,EAAA,CAAA,EAAAK,GAgMuBX,EAAkB,mBAAAW,GAC1B,MAAOO,EAAA,UAAUC,EAAW,YAAY,EACxC,MAAOA,EAAW,wDAKzBrB,EAUM,MAVNH,EAUM,CATJG,EAKM,MALNF,EAKM,CAJJU,EAAA,CAAA,IAAAA,EAAA,CAAA,EAAAR,EAAyB,cAAjB,WAAQ,EAAA,GAChBG,EAAgCgB,EAAA,CAAtB,MAAM,aAAa,CAAA,EAC7BhB,EAA2DgB,EAAA,CAAhD,MAAO,EAAI,cAAa,GAAM,MAAM,YAC/ChB,EAA4EgB,EAAA,CAAjE,MAAO,EAAI,cAAa,GAAM,SAAA,GAAS,MAAM,sBAE1DX,EAAA,CAAA,IAAAA,EAAA,CAAA,EAAAR,EAEM,MAFD,CAAA,MAAM,6DAA4D,MAEvE,EAAA,KAGFG,EAIEmB,EAAA,CAHA,cAAY,OACX,YAAWjB,EAAuB,wBAClC,WAAUA,EAAa,sDAtNlC,EAAA"}